var $,log,random_int;log=function(a){return console.log(a)},$=function(a){return document.getElementById(a)},random_int=function(a,b){return Math.floor(Math.random()*(b-a+1))+a};var GameObject;GameObject=function(){function a(){}return a.prototype.points=[],a.prototype.color="#fff",a.prototype.draw=function(a,b){var c,d,e;for(null==a&&(a=this.points),null==b&&(b=this.color),this.game.g.fillStyle=b,d=0,e=a.length;e>d;d++)c=a[d],this.game.g.fillRect(c[0]*this.game.size+1,c[1]*this.game.size+1,this.game.point_size,this.game.point_size)},a}();var Map,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Map=function(a){function b(a){var b,c,d,e,f,g,h;for(this.game=a,this.points=[],this.game.g=this.game.canvas.getContext("2d"),this.game.canvas.width=this.game.width*this.game.size,this.game.canvas.height=this.game.height*this.game.size,this.game.wrapper.style.width=""+this.game.canvas.width+"px",this.game.wrapper.style.height=""+this.game.canvas.height+"px",c=0,b=e=0,g=this.game.width;g>=0?g>e:e>g;b=g>=0?++e:--e)for(d=f=0,h=this.game.height;h>=0?h>f:f>h;d=h>=0?++f:--f)this.points[c++]=[b,d];this.game.point_size=this.game.size-2,this.draw(),log("Map "+this.game.width+"x"+this.game.height+" created!")}return __extends(b,a),b.prototype.color="#222",b.prototype.all_free=function(){var a,b,c,d,e,f;for(c=0,b=[],f=this.points,d=0,e=f.length;e>d;d++)a=f[d],this.game.snake.is_free(a)&&(b[c++]=a);return b},b}(GameObject);var Food,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Food=function(a){function b(a){this.game=a,this.respawn()}return __extends(b,a),b.prototype.color="green",b.prototype.respawn=function(){var a;a=this.game.map.all_free(),a.length>1?(this.points=[a[random_int(1,a.length-1)]],log("food at ["+this.points[0]+"]")):(this.game.stop(),this.game.over=!0,this.game.msg_bottom.show("WOOOOOW!!!<br>Snake has max size"))},b}(GameObject);var Snake,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Snake=function(a){function b(a){var b,c;this.game=a,b=Math.floor(this.game.width/2),c=Math.floor(this.game.height/2),this.points=[[b,c-1],[b,c],[b,c+1]],this.tail=[b-1,c+1],this.stack=[],this.direction=this.UP}return __extends(b,a),b.prototype.head_color="red",b.prototype.color="white",b.prototype.UP=1,b.prototype.RIGHT=2,b.prototype.DOWN=3,b.prototype.LEFT=4,b.prototype.move=function(){var a,b,c;switch(this.step(),b=this.points[0][0],c=this.points[0][1],this.direction){case this.UP:a=c>0?[b,c-1]:[b,this.game.height-1];break;case this.RIGHT:a=b<this.game.width-1?[b+1,c]:[0,c];break;case this.DOWN:a=c<this.game.height-1?[b,c+1]:[b,0];break;case this.LEFT:a=b>0?[b-1,c]:[this.game.width-1,c]}this.is_free(a)?(this.points.unshift(a),a[0]===this.game.food.points[0][0]&&a[1]===this.game.food.points[0][1]?(this.game.food.respawn(),this.game.score.next()):this.tail=this.points.pop()):(this.game.started=!1,this.game.over=!0,this.game.stop(),this.game.msg_bottom.show("GAME OVER! Your score <b>"+this.game.score.value+"</b>.<br>Press <b>R</b> to restart"))},b.prototype.step=function(){var a;this.stack[0]&&(a=this.stack.shift(),"r"===a?this.direction<4?this.direction++:this.direction=this.UP:"l"===a&&(this.direction>1?this.direction--:this.direction=this.LEFT))},b.prototype.turn=function(a){null==a&&(a="l"),this.stack.push(a)},b.prototype["try"]=function(a){switch(null==a&&(a="l"),a){case"l":this.direction===this.UP&&this.turn("l"),this.direction===this.DOWN&&this.turn("r");break;case"r":this.direction===this.UP&&this.turn("r"),this.direction===this.DOWN&&this.turn("l");break;case"u":this.direction===this.LEFT&&this.turn("r"),this.direction===this.RIGHT&&this.turn("l");break;case"d":this.direction===this.LEFT&&this.turn("l"),this.direction===this.RIGHT&&this.turn("r")}},b.prototype.is_free=function(a){var b,c,d,e,f;if(c=this.points[this.points.length-1],a[0]===c[0]&&a[1]===c[1])return!0;for(f=this.points,d=0,e=f.length;e>d;d++)if(b=f[d],a[0]===b[0]&&a[1]===b[1])return!1;return!0},b.prototype.draw=function(){b.__super__.draw.apply(this,arguments),b.__super__.draw.call(this,[this.tail],this.game.map.color),this.game.food.draw(),b.__super__.draw.call(this,[this.points[0]],this.head_color)},b}(GameObject);var Message,__bind=function(a,b){return function(){return a.apply(b,arguments)}};Message=function(){function a(a){this.tag=a,this.hide=__bind(this.hide,this)}return a.prototype.show=function(a,b){this.text=a,null==b&&(b=!1),this.tag.innerHTML=this.text,this.hide(),this.tag.setAttribute("class","msg_show"),b&&(this.last_time=setTimeout(this.hide,1e3*b))},a.prototype.hide=function(){clearTimeout(this.last_time),this.tag.setAttribute("class","msg_hide")},a}();var Score;Score=function(){function a(a){this.game=a,this.tag=$("score"),this.value=0,this.tag.textContent=this.value}return a.prototype.next=function(){return this.value+=this.game.speed.value,this.tag.textContent=this.value},a}();var Speed;Speed=function(){function a(a,b){this.game=a,this.value=b,this.tag=$("speed"),this.show()}return a.prototype.show=function(){this.game.msg_top.show("Speed is "+this.value,1,3),this.tag.textContent=this.value},a.prototype.up=function(){this.value>=30||(this.value++,this.show())},a.prototype.down=function(){this.value<=1||(this.value--,this.show())},a}();var Game,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};Game=function(){function a(a,b,c,d,e){this.width=null!=a?a:30,this.height=null!=b?b:30,this.size=null!=c?c:12,null==d&&(d=5),null==e&&(e=this.left_right),this.main_loop=__bind(this.main_loop,this),this.interupt=__bind(this.interupt,this),this.over=!1,this.wrapper=$("game"),this.canvas=$("game_canvas"),null!=this.canvas&&this.canvas.remove(),this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","game_canvas"),this.wrapper.appendChild(this.canvas),this.msg_top=new Message($("msg_top")),this.msg_bottom=new Message($("msg_bottom")),this.speed=new Speed(this,d),this.score=new Score(this),this.map=new Map(this),this.snake=new Snake(this),this.food=new Food(this),this.layout=e,window.captureEvents(Event.KEYPRESS),window.onkeydown=this.interupt,this.stop(),this.snake.draw()}return a.prototype.ESC=[27,13,32],a.prototype.LAYOUT=[76],a.prototype.LEFT=[37,65],a.prototype.RIGHT=[39,68],a.prototype.UP=[38,87],a.prototype.DOWN=[40,83],a.prototype.left_right=1,a.prototype.up_right_down_left=2,a.prototype.interupt=function(a){var b;a=a||window.event,b=a.which,this.over?82===b&&this["new"]():(__indexOf.call(this.LAYOUT,b)>=0&&this.switch_layout(),this.started?(this.layout===this.left_right?(__indexOf.call(this.LEFT,b)>=0&&this.snake.turn("l"),__indexOf.call(this.RIGHT,b)>=0&&this.snake.turn("r")):this.layout===this.up_right_down_left&&(__indexOf.call(this.LEFT,b)>=0&&this.snake["try"]("l"),__indexOf.call(this.RIGHT,b)>=0&&this.snake["try"]("r"),__indexOf.call(this.UP,b)>=0&&this.snake["try"]("u"),__indexOf.call(this.DOWN,b)>=0&&this.snake["try"]("d")),__indexOf.call(this.ESC,b)>=0&&this.stop()):(__indexOf.call(this.UP,b)>=0&&this.speed.up(),__indexOf.call(this.DOWN,b)>=0&&this.speed.down(),__indexOf.call(this.ESC,b)>=0&&this.start()))},a.prototype.switch_layout=function(){this.layout===this.left_right?(this.msg_top.show("Layout switched to &#9650;&#9654;&#9660;&#9664;",1,3),this.layout=this.up_right_down_left):this.layout===this.up_right_down_left&&(this.msg_top.show("Layout switched to &#9664;&#9654;",1,3),this.layout=this.left_right)},a.prototype.stop=function(){this.msg_bottom.show("Press <b>Space/Enter/Esc</b> to start"),clearInterval(this.interval),this.started=!1},a.prototype.start=function(){this.interval=setInterval(this.main_loop,1e3/this.speed.value/2),this.started=!0,this.msg_bottom.hide()},a.prototype.main_loop=function(){this.snake.move(),this.snake.draw()},a.prototype["new"]=function(a,b,c,d,e){null==a&&(a=this.width),null==b&&(b=this.height),null==c&&(c=this.size),null==d&&(d=this.speed.value),null==e&&(e=this.layout),this.stop(),this.constructor(a,b,c,d,e)},a}(),window.onload=function(){return window.game=new Game(25,15,20,6)};