var $,log,random_int;log=function(a){return console.log(a)},$=function(a){return document.getElementById(a)},random_int=function(a,b){return Math.floor(Math.random()*(b-a+1))+a};var GameObject;GameObject=function(){function a(){}return a.prototype.points=[],a.prototype.color="#fff",a.prototype.draw=function(a,b){var c,d,e;for(null==a&&(a=this.points),null==b&&(b=this.color),this.game.g.fillStyle=b,d=0,e=a.length;e>d;d++)c=a[d],this.game.g.fillRect(c[0]*this.game.size+1,c[1]*this.game.size+1,this.game.point_size,this.game.point_size)},a}();var Map,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Map=function(a){function b(a){var b,c,d,e,f,g,h;for(this.game=a,this.points=[],this.game.g=this.game.canvas.getContext("2d"),this.game.canvas.width=this.game.width*this.game.size,this.game.canvas.height=this.game.height*this.game.size,this.game.wrapper.style.width=""+this.game.canvas.width+"px",this.game.wrapper.style.height=""+this.game.canvas.height+"px",c=0,b=e=0,g=this.game.width;g>=0?g>e:e>g;b=g>=0?++e:--e)for(d=f=0,h=this.game.height;h>=0?h>f:f>h;d=h>=0?++f:--f)this.points[c++]=[b,d];this.game.point_size=this.game.size-2,this.draw(),log("Map "+this.game.width+"x"+this.game.height+" created!")}return __extends(b,a),b.prototype.color="#222",b.prototype.all_free=function(){var a,b,c,d,e,f;for(c=0,b=[],f=this.points,d=0,e=f.length;e>d;d++)a=f[d],this.game.snake.is_free(a)&&(b[c++]=a);return b},b}(GameObject);var Food,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Food=function(a){function b(a){this.game=a,this.respawn(),this.draw()}return __extends(b,a),b.prototype.color="green",b.prototype.respawn=function(){var a;return a=this.game.map.all_free(),a.length>0?(this.points=[a[random_int(1,a.length-1)]],log("food at ["+this.points[0]+"]")):(this.game.over=!0,this.game.msg.show("WOW!!! snake has max size"))},b}(GameObject);var Snake,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Snake=function(a){function b(a){var b,c;this.game=a,b=Math.floor(this.game.width/2),c=Math.floor(this.game.height/2),this.points=[[b,c-1],[b,c],[b,c+1]],this.tail=[b-1,c+1],this.stack=[],this.direction=this.UP,this.draw()}return __extends(b,a),b.prototype.head_color="red",b.prototype.color="white",b.prototype.UP=1,b.prototype.RIGHT=2,b.prototype.DOWN=3,b.prototype.LEFT=4,b.prototype.move=function(){var a,b,c;switch(this.turn(),b=this.points[0][0],c=this.points[0][1],this.direction){case this.UP:a=c>0?[b,c-1]:[b,this.game.height-1];break;case this.RIGHT:a=b<this.game.width-1?[b+1,c]:[0,c];break;case this.DOWN:a=c<this.game.height-1?[b,c+1]:[b,0];break;case this.LEFT:a=b>0?[b-1,c]:[this.game.width-1,c]}this.is_free(a)||this.is_tail(a)?(this.points.unshift(a),a[0]===this.game.food.points[0][0]&&a[1]===this.game.food.points[0][1]?(this.game.food.respawn(),this.game.score.next()):this.tail=this.points.pop()):(this.game.started=!1,this.game.over=!0,this.game.stop(),this.game.msg.show("GAME OVER! Your score <b>"+this.game.score.value+"</b>.<br>Press <b>R</b> to restart"))},b.prototype.turn=function(){var a;return this.stack[0]?(a=this.stack.shift(),"r"===a?this.direction<4?this.direction++:this.direction=this.UP:"l"===a?this.direction>1?this.direction--:this.direction=this.LEFT:log("turn failed")):void 0},b.prototype.turn_left=function(){return this.stack.push("l")},b.prototype.turn_right=function(){return this.stack.push("r")},b.prototype.is_free=function(a){var b,c,d,e;for(e=this.points,c=0,d=e.length;d>c;c++)if(b=e[c],a[0]===b[0]&&a[1]===b[1])return!1;return!0},b.prototype.is_tail=function(a){var b;return b=this.points[this.points.length-1],a[0]===b[0]&&a[1]===b[1]?!0:!1},b.prototype.draw=function(){return b.__super__.draw.apply(this,arguments),b.__super__.draw.call(this,[this.tail],this.game.map.color),b.__super__.draw.call(this,[this.points[0]],this.head_color)},b}(GameObject);var Message;Message=function(){function a(){this.tag=$("msg")}return a.prototype.show=function(a){return this.text=a,this.tag.innerHTML=this.text,this.hide(),this.tag.setAttribute("class","msg_show")},a.prototype.hide=function(){return this.tag.setAttribute("class","msg_hide")},a}();var Score;Score=function(){function a(a){this.game=a,this.tag=$("score"),this.value=0,this.tag.textContent=this.value}return a.prototype.next=function(){return this.value+=this.game.speed.value,this.tag.textContent=this.value},a}();var Speed;Speed=function(){function a(a,b){this.game=a,this.value=b,this.tag=$("speed"),this.show()}return a.prototype.show=function(){return this.tag.textContent=this.value},a.prototype.up=function(){return this.value>=30?void 0:(this.value++,this.show())},a.prototype.down=function(){return this.value<=1?void 0:(this.value--,this.show())},a}();var Game,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};Game=function(){function a(a,b,c,d){this.width=null!=a?a:30,this.height=null!=b?b:30,this.size=null!=c?c:12,null==d&&(d=5),this.interupt=__bind(this.interupt,this),this.over=!1,this.wrapper=$("game"),this.canvas=$("game_canvas"),null!=this.canvas&&this.canvas.remove(),this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","game_canvas"),this.wrapper.appendChild(this.canvas),this.msg=new Message,this.speed=new Speed(this,d),this.score=new Score(this),this.map=new Map(this),this.snake=new Snake(this),this.food=new Food(this),window.captureEvents(Event.KEYPRESS),window.onkeydown=this.interupt,this.stop()}return a.prototype.ESC=[27,13,32],a.prototype.LEFT=[37,65],a.prototype.RIGHT=[39,68],a.prototype.UP=[38,87],a.prototype.DOWN=[40,83],a.prototype.interupt=function(a){var b;a=a||window.event,b=a.which,this.over?82===b&&this["new"]():this.started?(__indexOf.call(this.LEFT,b)>=0&&this.snake.turn_left(),__indexOf.call(this.RIGHT,b)>=0&&this.snake.turn_right(),__indexOf.call(this.ESC,b)>=0&&this.stop()):(__indexOf.call(this.UP,b)>=0&&this.speed.up(),__indexOf.call(this.DOWN,b)>=0&&this.speed.down(),__indexOf.call(this.ESC,b)>=0&&this.start())},a.prototype.stop=function(){this.msg.show("Press <b>Space/Enter/Esc</b> to start"),clearInterval(this.interval),this.started=!1},a.prototype.start=function(){this.interval=setInterval(this.main_loop.bind(this),1e3/this.speed.value/2),this.started=!0,this.msg.hide()},a.prototype.main_loop=function(){this.snake.move(),this.snake.draw(),this.food.draw()},a.prototype["new"]=function(a,b,c,d){return null==a&&(a=this.width),null==b&&(b=this.height),null==c&&(c=this.size),null==d&&(d=this.speed.value),this.stop(),this.constructor(a,b,c,d)},a}(),window.onload=function(){return window.game=new Game(25,15,20,6)};